# Soccer360 Pipeline Configuration

paths:
  ingest: /tank/ingest
  scratch: /scratch/work
  processed: /tank/processed
  highlights: /tank/highlights
  models: /tank/models
  labeling: /tank/labeling
  archive_raw: /tank/archive_raw
  logs: /tank/logs

model:
  path: /app/models/ball_best.pt
  base_model: yolov8s.pt
  tensorrt_path: /app/models/ball_best.engine
  # Inference backend: fp32 (default baseline) or tensorrt_int8 (optimization)
  backend: fp32

detector:
  batch_size: 16
  batch_size_tensorrt: 32
  resolution: [1920, 960]
  confidence_threshold: 0.25
  nms_iou_threshold: 0.45
  # Process every Nth frame (1 = all frames, 2 = skip every other, etc.)
  # Skipped frames get positions interpolated from neighbors
  process_every_n_frames: 1
  tiling:
    enabled: false
    tiles: 4
    overlap: 0.1

field_of_interest:
  enabled: true
  # fixed: use center_yaw_deg as-is; auto: compute from first N seconds of detections
  center_mode: fixed
  center_yaw_deg: 0
  yaw_window_deg: 200        # +/-100 from center
  pitch_min_deg: -45
  pitch_max_deg: 20
  auto_sample_seconds: 30    # seconds to sample for auto center mode
  auto_min_conf: 0.25        # min detection confidence for auto-center sampling

tracker:
  algorithm: bytetrack
  track_high_thresh: 0.25
  track_low_thresh: 0.1
  new_track_thresh: 0.25
  track_buffer: 30
  match_thresh: 0.4
  # Ball selection sanity checks (all values in detector.resolution pixel space)
  # At default resolution [1920, 960], 200px â‰ˆ 10% of frame width
  max_speed_px_per_frame: 200
  max_displacement_px: 300
  min_bbox_area: 10
  max_bbox_area: 10000

camera:
  max_pan_speed_deg_per_sec: 60.0
  max_fast_pan_speed_deg_per_sec: 120.0
  ema_alpha: 0.15
  default_fov: 90.0
  min_fov: 80.0
  max_fov: 100.0
  lost_coast_frames: 30
  lost_drift_frames: 90
  field_center_yaw_deg: 0.0
  field_center_pitch_deg: -5.0
  # Deadband: ignore movements smaller than this to prevent micro-oscillation
  deadband_deg: 0.5
  # Minimum velocity threshold to start camera movement (deg/sec)
  velocity_threshold_deg_per_sec: 2.0
  # Immediately widen FOV when ball is lost
  lost_fov_widen: true
  kalman:
    process_noise: 0.1
    measurement_noise: 1.0

reframer:
  output_resolution: [1920, 1080]
  # Pass source frames at native resolution to e2p (null = no downscale)
  # Set to [3840, 1920] to downscale before reframing for speed
  source_downscale: null
  num_workers: 12
  interpolation: bilinear
  # Seconds of overlap at segment boundaries for codec warmup (clean cuts)
  overlap_sec: 0.5
  tactical_fov: 120
  tactical_yaw: 0.0
  tactical_pitch: -5.0

highlights:
  speed_percentile: 95
  direction_change_deg: 90
  goal_box_regions:
    - [0.0, 0.3, 0.08, 0.7]
    - [0.92, 0.3, 1.0, 0.7]
  pre_margin_sec: 5.0
  post_margin_sec: 3.0
  min_clip_gap_sec: 5.0
  min_clip_duration_sec: 3.0

exporter:
  codec: libx264
  crf: 18
  preset: medium
  # Encoder: cpu (libx264/libx265) or nvenc (NVIDIA hardware encoder)
  encoder: cpu
  audio: copy
  archive_raw: false
  delete_raw: false

watcher:
  extensions: [".mp4", ".insv", ".mov"]
  # Ignore files still being uploaded (staging extensions)
  ignore_suffixes: [".uploading", ".tmp", ".part"]
  # File size must be stable for stability_checks * stability_interval_sec
  # Default: 5 * 10s = 50 seconds of stable size before processing
  stability_checks: 5
  stability_interval_sec: 10.0
  # Persisted dedupe state file.
  # Relative paths resolve under: <paths.processed>/.state/
  processed_state_file: watcher_processed_ingest.json
  # Cap persisted dedupe records to bound on-disk growth (0 = unlimited)
  processed_state_max_entries: 50000

ingest:
  archive_on_success: true
  archive_dir: /tank/archive_raw
  # move: relocate original out of ingest (atomic rename or copy+delete)
  # copy: keep original in ingest, place a copy in archive_dir
  # leave: do nothing (disable archival regardless of archive_on_success)
  archive_mode: move
  # Available placeholders: {match} = input stem, {job_id} = pipeline job id, {ext} = .mp4 etc.
  archive_name_template: "{match}_{job_id}{ext}"
  # suffix: append _01, _02, ... if destination exists
  # skip: leave source in ingest and log warning
  # overwrite: replace destination (log warning)
  archive_collision: suffix

active_learning:
  enabled: true
  export_dir: /tank/labeling
  export_max_frames: 600
  # Only export candidate frames whose frame_index % export_every_n_frames == 0
  export_every_n_frames: 2
  # Low-confidence band: detections in [low_conf_min, low_conf_max] are hard frames
  low_conf_min: 0.20
  low_conf_max: 0.50
  # Lost-ball run: export one representative frame when streak reaches this many frames
  lost_run_frames: 15
  # Jump/speed rejection export threshold (only export if distance >= this)
  jump_trigger_px: 200

# --- V1 Bootstrap Detection ---
# COCO-pretrained YOLOv8s for sports ball (class 32) detection
detection:
  path: "yolov8s.pt"
  classes: [32]              # COCO sports ball
  conf: 0.35
  iou: 0.5
  img_size: 960
  max_det: 20
  half: true
  device: "cuda:0"

# Spatial and temporal filters for detection quality
filters:
  # Vertical band filter: reject detections outside [min_y_frac, max_y_frac]
  # Removes sky, scoreboard, and below-pitch false positives
  min_y_frac: 0.20
  max_y_frac: 0.98
  # Jump/speed sanity (used by BallStabilizer for rejection)
  max_jump_px: 250
  max_speed_px_per_s: 2500

# V1 ball stabilization: persistence gate + EMA smoothing
tracking:
  ema_alpha: 0.35
  require_persistence: 2     # require N detections in window to accept
  window: 3                  # rolling window size

mode:
  allow_no_model: true

logging:
  level: INFO
  file: /tank/logs/soccer360.log
